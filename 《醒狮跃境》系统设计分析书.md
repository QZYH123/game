# **《醒狮跃境》系统设计分析书**

## 1. 系统架构设计

### 1.1 整体架构模式

基于Cocos2d-x引擎，采用**ECS架构**与**观察者模式**相结合的混合架构模式：

```mermaid
graph TB
    A[游戏应用层] --> B[核心系统层]
    B --> C[实体组件层]
    C --> D[数据资源层]
    
    B --> B1[场景管理系统]
    B --> B2[事件调度系统]
    B --> B3[资源管理系统]
    
    C --> C1[实体管理器]
    C --> C2[组件池]
    C --> C3[系统处理器]
```

### 1.2 ECS架构设计

```mermaid
graph LR
    E[实体Entity] --> C[组件Component]
    C --> S[系统System]
    
    subgraph 实体示例
        E1[舞狮实体] --> C1[变换组件]
        E1 --> C2[物理组件]
        E1 --> C3[动画组件]
        E1 --> C4[神态组件]
    end
    
    subgraph 系统示例
        S1[物理系统] --> C2
        S2[动画系统] --> C3
        S3[神态系统] --> C4
    end
```

## 2. 核心系统模块设计

### 2.1 实体组件系统设计

#### 2.1.1 核心实体类型
- **舞狮实体**：包含双玩家控制的复合实体
- **机关实体**：可交互的关卡元素
- **平台实体**：地形和移动平台
- **UI实体**：界面显示元素

#### 2.1.2 关键组件设计

```mermaid
classDiagram
    class TransformComponent {
        +Vec2 position
        +float rotation
        +Vec2 scale
        +updateTransform()
    }
    
    class PhysicsComponent {
        +Vec2 velocity
        +Vec2 acceleration
        +bool isGrounded
        +applyForce()
    }
    
    class LionDanceComponent {
        +PlayerRole role
        +ExpressionType currentExpression
        +bool isCooperationReady
        +changeExpression()
    }
    
    class MechanismComponent {
        +MechanismType type
        +bool isActivated
        +ExpressionType requiredExpression
        +onInteract()
    }
    
    TransformComponent <|-- PhysicsComponent
    PhysicsComponent <|-- LionDanceComponent
```

### 2.2 观察者模式事件系统

```mermaid
sequenceDiagram
    participant IS as 输入系统
    participant ES as 事件调度器
    participant LS as 神态系统
    participant MS as 机关系统
    
    IS->>ES: 玩家触发神态(ExpressionEvent)
    ES->>LS: 通知神态变化
    LS->>LS: 更新神态状态
    LS->>ES: 发出神态激活事件
    ES->>MS: 通知机关系统
    MS->>MS: 检查机关触发条件
```

## 3. 系统模块详细设计

### 3.1 双人控制系统

```mermaid
stateDiagram-v2
    [*] --> Idle
    Idle --> Moving: 输入移动
    Moving --> Jumping: 按下跳跃
    Jumping --> Falling: 到达顶点
    Falling --> Idle: 落地
    
    state Cooperation {
        [*] --> Ready
        Ready --> PowerJump: 双人同时跳跃
        PowerJump --> [*]
    }
    
    Idle --> Cooperation: 进入合作状态
```

**关键设计要点**：
- 狮头玩家控制移动方向和基本跳跃
- 狮尾玩家控制抬尾动作和重量变化
- 合作动作通过状态同步实现

### 3.2 神态系统设计

```mermaid
graph TD
    A[输入检测] --> B{神态触发条件}
    B --> C[醒神状态]
    B --> D[酣睡状态]
    B --> E[疑惑状态]
    B --> F[试探状态]
    
    C --> C1[激活光照机关]
    D --> D1[触发重量机关]
    E --> E1[吸引中立生物]
    F --> F1[显示隐藏平台]
    
    C1 --> G[机关反馈]
    D1 --> G
    E1 --> G
    F1 --> G
```

### 3.3 关卡与谜题系统

```mermaid
graph TB
    A[关卡管理器] --> B[关卡加载]
    A --> C[进度保存]
    
    B --> D[实体生成]
    D --> E[机关布置]
    D --> F[平台生成]
    D --> G[目标设置]
    
    E --> H[谜题逻辑]
    F --> I[平台行为]
    G --> J[胜利条件]
    
    H --> K[事件触发]
    I --> K
    J --> L[关卡完成]
```

## 4. 数据流设计

### 4.1 游戏状态数据流

```mermaid
flowchart TD
    A[玩家输入] --> B[输入系统]
    B --> C[实体状态更新]
    C --> D[物理系统计算]
    D --> E[碰撞检测]
    E --> F[事件触发]
    F --> G[游戏逻辑处理]
    G --> H[渲染系统]
    H --> I[画面显示]
    
    F --> J[音效系统]
    G --> K[UI系统更新]
```

### 4.2 ECS数据更新流程

```mermaid
sequenceDiagram
    participant GS as 游戏循环
    participant SM as 系统管理器
    participant PS as 物理系统
    participant AS as 动画系统
    participant RS as 渲染系统
    
    GS->>SM: update(deltaTime)
    SM->>PS: processEntities()
    PS->>PS: 更新物理状态
    PS->>AS: 发送状态变化事件
    AS->>AS: 更新动画状态
    AS->>RS: 发送渲染指令
    RS->>RS: 绘制画面
```

## 5. 场景与界面系统设计

### 5.1 场景管理状态机

```mermaid
stateDiagram-v2
    [*] --> MainMenu
    MainMenu --> LevelSelect: 开始游戏
    LevelSelect --> GamePlay: 选择关卡
    GamePlay --> PauseMenu: 暂停游戏
    PauseMenu --> GamePlay: 继续游戏
    PauseMenu --> LevelSelect: 退出关卡
    GamePlay --> LevelComplete: 完成关卡
    LevelComplete --> LevelSelect: 返回选择
    LevelSelect --> MainMenu: 返回主菜单
```

### 5.2 UI系统架构

```mermaid
graph TB
    A[UIManager] --> B[界面栈管理]
    A --> C[输入事件路由]
    
    B --> D[主菜单界面]
    B --> E[关卡选择界面]
    B --> F[游戏HUD]
    B --> G[暂停菜单]
    B --> H[通关界面]
    
    F --> F1[神态提示]
    F --> F2[按键映射显示]
    F --> F3[关卡信息]
```

## 6. 资源管理系统设计

### 6.1 资源加载流程

```mermaid
flowchart LR
    A[启动游戏] --> B[加载配置]
    B --> C[预加载核心资源]
    C --> D[显示加载界面]
    D --> E[异步加载关卡资源]
    E --> F[资源验证]
    F --> G[初始化场景]
    G --> H[游戏就绪]
```

### 6.2 资源分类管理

```mermaid
graph TD
    A[资源管理器] --> B[纹理资源]
    A --> C[音频资源]
    A --> D[动画资源]
    A --> E[关卡数据]
    A --> F[配置数据]
    
    B --> B1[角色纹理]
    B --> B2[场景纹理]
    B --> B3[UI纹理]
    
    C --> C1[背景音乐]
    C --> C2[音效]
```

## 7. 性能优化设计

### 7.1 对象池设计

```mermaid
flowchart TD
    A[实体创建请求] --> B{对象池有空闲对象?}
    B -->|是| C[从池中获取]
    B -->|否| D[创建新对象]
    C --> E[初始化对象]
    D --> E
    E --> F[使用对象]
    F --> G{对象需要销毁?}
    G -->|是| H[回收到对象池]
    G -->|否| F
```

### 7.2 渲染优化策略

- **动态批处理**：相同材质的精灵自动批处理
- **视锥裁剪**：只渲染屏幕内可见对象
- **LOD系统**：根据距离调整渲染细节
- **纹理图集**：合并小纹理减少绘制调用

## 8. 扩展性设计

### 8.1 模块化扩展接口

```mermaid
graph TB
    A[核心框架] --> B[模块接口]
    
    B --> C[新神态扩展]
    B --> D[新机关类型]
    B --> E[新平台行为]
    B --> F[新关卡机制]
    
    C --> C1[实现ExpressionComponent]
    D --> D1[实现MechanismComponent]
    E --> E1[继承PlatformBehavior]
    F --> F1[实现LevelLogic接口]
```

## 9. 关键技术决策

### 9.1 Cocos2d-x特定优化

- 使用Cocos2d-x的**节点树**管理场景层次
- 利用**Action系统**处理动画和移动
- **事件分发器**实现观察者模式
- **Schedule机制**替代传统游戏循环

### 9.2 ECS在Cocos2d-x中的实现策略

- 实体对应CCNode派生类
- 组件作为附加属性存在
- 系统通过Schedule定时更新
- 观察者模式连接各系统间通信

---

